rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Helper: role check via custom auth claims OR users doc
    function hasRole(role) {
      return request.auth != null && (
        (request.auth.token.role != null && request.auth.token.role == role) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role)
      );
    }

    // Helper functions for specific roles
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isOfficer() {
      return hasRole('officer');
    }
    
    function isSupervisor() {
      return hasRole('supervisor');
    }
    
    function isLawEnforcement() {
      return isOfficer() || isSupervisor();
    }
    
    function isCitizen() {
      return hasRole('citizen');
    }

    // Helper: validate Expo push token format
    function isValidExpoPushToken(token) {
      // Regex: must start with ExponentPushToken[ ... ]
      return token is string && token.matches('^ExponentPushToken\\[[^\\]]+\\]$');
    }

    // Validation helpers
    function validPriorities() { return ['low', 'medium', 'high', 'critical']; }
    function validSubmissionTypes() { return ['anonymous', 'authenticated']; }
    function validMainCategories() { return ['crime', 'child_abuse', 'women_abuse', 'other']; }
    function validReportStatuses() { return ['pending', 'validated', 'assigned', 'accepted', 'responding', 'resolved', 'rejected']; }

    function isValidCoordinates(coords) {
      return coords is map && coords.latitude is number && coords.longitude is number;
    }

    function isValidLocation(loc) {
      return loc is map
        && (!loc.keys().hasAny(['coordinates']) || isValidCoordinates(loc.coordinates))
        && (!loc.keys().hasAny(['address']) || (loc.address is string))
        && (!loc.keys().hasAny(['accuracy']) || (loc.accuracy is number));
    }

    function hasOnlyAllowedCreateKeys(data) {
      return data.keys().hasOnly([
        'user_id',
        'status',
        'assignmentStatus',
        'assignedTo',
        'priority',
        'mainCategory',
        'category',
        'description',
        'location',
        'media_urls',
        'officerNotes',
        'resolutionNotes',
        'timestamp',
        'updatedAt',
        'submission_type',
        'media_count',
        'has_location'
      ]);
    }

    function isValidReportCreate(data) {
      return (data.user_id is string)
        && (data.category is string)
        && (data.description is string)
        && (data.status == 'pending')
        && (data.timestamp is timestamp)
        && (!data.keys().hasAny(['priority']) || (data.priority in validPriorities()))
        && (!data.keys().hasAny(['mainCategory']) || (data.mainCategory in validMainCategories()))
        && (!data.keys().hasAny(['submission_type']) || (data.submission_type in validSubmissionTypes()))
        && (!data.keys().hasAny(['media_urls']) || (data.media_urls is list))
        && (!data.keys().hasAny(['media_count']) || (data.media_count is number))
        && (!data.keys().hasAny(['has_location']) || (data.has_location is bool))
        && (!data.keys().hasAny(['location']) || isValidLocation(data.location));
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    
    match /users/{userId} {
      // Users can read and write their own data
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow admins to read and update all users (for user management)
      allow read, update: if isAdmin();
      
      // Allow supervisors to read officer profiles in their unit
      allow read: if isSupervisor();
      
      // Allow user creation during registration (citizen, officer, admin)
      allow create: if request.auth != null && 
                   request.auth.uid == userId &&
                   request.resource.data.keys().hasAll(['email', 'role', 'createdAt']) &&
                   request.resource.data.role in ['citizen', 'officer', 'supervisor', 'admin'];
    }

    // ============================================
    // OFFICERS COLLECTION (for push tokens)
    // ============================================
    
    match /officers/{officerId} {
      // Read allowed for the officer themselves, supervisors, and admins
      allow read: if (request.auth != null && request.auth.uid == officerId)
                  || isSupervisor()
                  || isAdmin();

      // Create allowed for the authenticated officer
      allow create: if request.auth != null && request.auth.uid == officerId &&
                    // If pushToken provided at create, validate format
                    (!request.resource.data.keys().hasAny(['pushToken']) || isValidExpoPushToken(request.resource.data.pushToken));

      // Update allowed only for the authenticated officer and only specific keys
      allow update: if request.auth != null
                    && request.auth.uid == officerId
                    && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                      'pushToken',
                      'lastTokenUpdate'
                    ])
                    && (
                      // Allow clearing the token
                      (request.resource.data.keys().hasAny(['pushToken']) && request.resource.data.pushToken == null)
                      ||
                      // Or when setting/updating, ensure valid Expo token format
                      (!request.resource.data.keys().hasAny(['pushToken']))
                      ||
                      isValidExpoPushToken(request.resource.data.pushToken)
                    );
    }

    // ============================================
    // REPORTS COLLECTION
    // ============================================
    
    match /reports/{reportId} {
      
      // CREATE RULES
      // Citizens (including anonymous) can create reports they own
      allow create: if request.auth != null &&
                    request.resource.data.keys().hasAll(['user_id', 'category', 'description', 'status', 'timestamp']) &&
                    hasOnlyAllowedCreateKeys(request.resource.data) &&
                    isValidReportCreate(request.resource.data) &&
                    // Prevent citizen from pre-setting assignment or officer-only fields
                    !request.resource.data.keys().hasAny(['assignedTo', 'assignmentStatus', 'officerNotes', 'resolutionNotes']) &&
                    (
                      request.resource.data.user_id == request.auth.uid ||
                      (request.auth.token.firebase.sign_in_provider == 'anonymous' &&
                       request.resource.data.user_id == request.auth.uid)
                    );
      
      // READ RULES
      // Unified read access for owner, assigned officer, supervisors, and admins
      allow read: if request.auth != null && (
        resource.data.user_id == request.auth.uid ||          // Citizens see their own reports
        resource.data.assignedTo == request.auth.uid ||       // Officers see assigned reports  
        isSupervisor() ||                                      // Supervisors see all reports
        isAdmin()                                              // Admins see all reports
      );
      
      // UPDATE RULES
      
      // Officers can update reports assigned to them with restricted fields and valid transitions
      allow update: if request.auth != null &&
                    isOfficer() &&
                    resource.data.assignedTo == request.auth.uid &&
                    // Only allow specific fields
                    request.resource.data.diff(resource.data).changedKeys().hasOnly([
                      'status',
                      'assignmentStatus',
                      'officerNotes',
                      'resolutionNotes',
                      'updatedAt',
                      'declineReason',
                      'assignedTo'
                    ]) &&
                    // Enforce basic state transitions
                    (
                      // Accept assignment -> accepted
                      (resource.data.status == 'assigned' &&
                       request.resource.data.status == 'accepted' &&
                       request.resource.data.assignmentStatus == 'accepted' &&
                       request.resource.data.assignedTo == request.auth.uid) ||

                      // accepted -> responding
                      (resource.data.status == 'accepted' &&
                       request.resource.data.status == 'responding') ||

                      // responding -> resolved/rejected
                      (resource.data.status == 'responding' &&
                       request.resource.data.status in ['resolved', 'rejected']) ||

                      // Decline assignment -> unassigned
                      (request.resource.data.assignmentStatus == 'declined' &&
                       request.resource.data.status == 'unassigned' &&
                       request.resource.data.assignedTo == null) ||

                      // Note-only update (no status change) â€” allow updating just officerNotes and updatedAt
                      (request.resource.data.diff(resource.data).changedKeys().hasOnly(['officerNotes', 'updatedAt']))
                    );
      
      // Supervisors can read and update all reports (full access)
      allow read, update: if isSupervisor();
      
      // Admins can read, update, and delete all reports (full access)
      allow read, update, delete: if isAdmin();
    }

    // ============================================
    // REPORT EVIDENCE SUBCOLLECTION
    // ============================================
    
    match /reports/{reportId}/report_evidence/{evidenceId} {
      // Officers assigned to the report can read and create evidence
      allow read, create: if request.auth != null &&
                         get(/databases/$(database)/documents/reports/$(reportId)).data.assignedTo == request.auth.uid &&
                         isLawEnforcement();
      
      // Supervisors can read all evidence
      allow read: if isSupervisor();
      
      // Admins can read all evidence
      allow read: if isAdmin();
      
      // Evidence is immutable once created (no updates/deletes for security)
      allow update, delete: if false;
    }

    // ============================================
    // AUDIT LOGS COLLECTION
    // ============================================
    
    match /audit_logs/{logId} {
      // Law enforcement and admins can read audit logs
      allow read: if isLawEnforcement() || isAdmin();

      // Allow creating new audit entries (append-only)
      allow create: if (isLawEnforcement() || isAdmin()) &&
                    // Prevent raw note/comment text from being stored in details map
                    (
                      !(request.resource.data.details is map) ||
                      !request.resource.data.details.keys().hasAny(['note', 'text', 'comment', 'commentText'])
                    );

      // Logs are immutable: no updates or deletes for anyone (including admins)
      allow update, delete: if false;
    }

    // ============================================
    // CATCH-ALL DENY RULE
    // ============================================
    
    // Deny all other operations not explicitly allowed
    match /{document=**} {
      allow read, write: if false;
    }
  }
}